# Copyright (C) 2023 Sukhveer Singh
# SPDX-License-Identifier: GPL-3.0-or-later

from pathlib import Path

import pytest

from cve_bin_tool.generic_checker import GenericChecker


class TestHelperScript:
    TEST_FILE_PATH = Path(__file__).parent.resolve() / "generic_checker_test_data"

    Libsrtp_product_name = ["gcc", "libsrtp"]
    Libsrtp_version_number = ["8.2.1", "1.5.4"]

    Libbotan_product_name = ["botan", "Botan"]
    Libbotan_version_number = ["2.4.0", "2.4.0"]

    Libssh_product_name = ["OpenSSL"]
    Libssh_version_number = ["3.0.5"]

    Gpm_product_name = ["running", "annobin", "gpm", "gpm"]
    Gpm_version_number = ["gcc", "gcc", "1.20.8", "1.20.7"]

    Dhcpcd_product_name = ["running", "annobin", "dhcpcd", "dhcpcd-9.4.1"]
    Dhcpcd_version_name = ["gcc", "gcc", "9.4.1", "starting"]

    @pytest.mark.parametrize(
        "filename, product_name, version_name",
        [
            (
                str(TEST_FILE_PATH / "libsrtp-1.5.4-8.el8.aarch64.rpm"),
                Libsrtp_product_name,
                Libsrtp_version_number,
            ),
            (
                str(TEST_FILE_PATH / "libbotan-2-4_2.4.0-5~bpo9+1_amd64.deb"),
                Libbotan_product_name,
                Libbotan_version_number,
            ),
            (
                str(TEST_FILE_PATH / "libssh-4_0.10.4-2_amd64.deb"),
                Libssh_product_name,
                Libssh_version_number,
            ),
            (
                str(TEST_FILE_PATH / "gpm-1.20.7-42.fc38.aarch64.rpm"),
                Gpm_product_name,
                Gpm_version_number,
            ),
            (
                str(TEST_FILE_PATH / "dhcpcd-9.4.1-4.fc38.x86_64.rpm"),
                Dhcpcd_product_name,
                Dhcpcd_version_name,
            ),
        ],
    )
    def test_parse_filename(self, filename, product_name, version_name):
        hs = GenericChecker()
        hs.operator_function(filename)
        for product in product_name:
            assert product in hs.product_list
        for version in version_name:
            assert version in hs.version_list
